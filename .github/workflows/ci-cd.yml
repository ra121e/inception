name: CI/CD for Inception

on:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        run: |
          # 1. 必要なディレクトリをすべて作成
          mkdir -p srcs/data/mariadb srcs/data/wordpress secrets

          # 2. Secretsの配置
          echo "${{ secrets.CREDENTIALS }}" > secrets/credentials.txt
          echo "${{ secrets.DB_ROOT_PASSWORD }}" > secrets/db_root_password.txt
          echo "${{ secrets.DB_PASSWORD }}" > secrets/db_password.txt

          # 3. .envの配置（中身からLOGINやDATA_PATHの依存を消すのが理想）
          echo "${{ secrets.ENV_FILE }}" > srcs/.env

      - name: Build and Test
        run: |
          export DATA_PATH="${{ github.workspace }}/srcs/data"

          # ルートから -f でファイルを指定。working-directoryは使わない
          # .envファイルのパスも明示する
          docker compose -f srcs/docker-compose.yml --env-file srcs/.env build
          docker compose -f srcs/docker-compose.yml --env-file srcs/.env run --rm wordpress echo "Success"

  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # EC2上のプロジェクトルートへ移動
            cd ~/inception

            # ディレクトリ準備
            mkdir -p srcs/data/mariadb srcs/data/wordpress secrets

            # ファイル更新（git pull等の代わり）
            echo "${{ secrets.ENV_FILE }}" > srcs/.env
            echo "${{ secrets.CREDENTIALS }}" > secrets/credentials.txt

            export DATA_PATH="$(pwd)/srcs/data"

            # デプロイ実行
            docker compose -f srcs/docker-compose.yml up -d --build
