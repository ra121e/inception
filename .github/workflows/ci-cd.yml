name: CI/CD for Inception

on:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create secrets directory
        run: mkdir -p secrets

      - name: Create credentials and secret files
        run: |
          echo "${{ secrets.CREDENTIALS }}" > secrets/credentials.txt
          echo "${{ secrets.DB_ROOT_PASSWORD }}" > secrets/db_root_password.txt
          echo "${{ secrets.DB_PASSWORD }}" > secrets/db_password.txt

      - name: Create .env file for CI
        working-directory: srcs
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          # CI環境(Runner)専用のパスを注入
          echo "DATA_PATH=${{ github.workspace }}/data" >> .env
          # ボリュームマウント用のディレクトリ作成
          mkdir -p ${{ github.workspace }}/data/mariadb
          mkdir -p ${{ github.workspace }}/data/wordpress

      - name: Build Docker Compose images
        working-directory: srcs
        run: docker compose build

      - name: Test Docker Compose
        working-directory: srcs
        run: |
          # テスト実行（DATA_PATHが正しくマウントされれば成功する）
          docker compose run --rm wordpress echo "WordPress container built and mounted successfully"

  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/inception/srcs

            # 既存の .env をクリアして Secrets から再生成
            echo "${{ secrets.ENV_FILE }}" > .env

            # 本番環境(EC2)専用のパスを注入
            # ※ athondaさんの環境に合わせて固定パスを指定
            echo "DATA_PATH=/home/athonda/data" >> .env

            # Secretsファイルの生成
            mkdir -p ../secrets
            echo "${{ secrets.CREDENTIALS }}" > ../secrets/credentials.txt
            echo "${{ secrets.DB_ROOT_PASSWORD }}" > ../secrets/db_root_password.txt
            echo "${{ secrets.DB_PASSWORD }}" > ../secrets/db_password.txt

            # ディレクトリの存在確認（念のため）
            mkdir -p /home/athonda/data/mariadb
            mkdir -p /home/athonda/data/wordpress

            # デプロイ実行
            docker compose pull
            docker compose up -d --build
