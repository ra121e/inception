name: CI/CD for Inception

on:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        run: |
          # 1. 必要なディレクトリをすべて作成
          mkdir -p srcs/data/mariadb srcs/data/wordpress secrets

          # 2. Secretsの配置
          echo "${{ secrets.CREDENTIALS }}" > secrets/credentials.txt
          echo "${{ secrets.DB_ROOT_PASSWORD }}" > secrets/db_root_password.txt
          echo "${{ secrets.DB_PASSWORD }}" > secrets/db_password.txt

          # 3. .envの配置（中身からLOGINやDATA_PATHの依存を消すのが理想）
          echo "${{ secrets.ENV_FILE }}" > srcs/.env

      - name: Build and Test
        run: |
          # 全サービスをビルドして起動
          docker compose -f srcs/docker-compose.yml --env-file srcs/.env up -d --build

      - name: Health check (Web access test)
        # ここを分けることで「意味論の検証」が独立する
        run: |
          # nginx (HTTPS / self-signed cert)
          curl -k --fail --retry 10 --retry-delay 5 --retry-all-errors https://localhost

          # adminer (HTTP)
          curl --fail --retry 10 --retry-delay 5 --retry-all-errors http://localhost:8080

          # static (HTTP)
          curl --fail --retry 10 --retry-delay 5 --retry-all-errors http://localhost:8081

  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          command_timeout: 45m
          script_stop: true
          script: |
            set -e

            # EC2上のプロジェクトルート
            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            if [ -z "${APP_DIR}" ]; then
              APP_DIR="$HOME/inception"
            fi
            if [ "${APP_DIR#~/}" != "${APP_DIR}" ]; then
              APP_DIR="$HOME/${APP_DIR#~/}"
            fi
            if [ "${APP_DIR#/}" = "${APP_DIR}" ]; then
              echo "EC2_APP_DIR must be an absolute path (or start with ~/)."
              exit 1
            fi

            # クローン元（private リポジトリなら EC2_REPO_URL に SSH URL を設定）
            REPO_URL="${{ secrets.EC2_REPO_URL }}"
            if [ -z "${REPO_URL}" ]; then
              REPO_URL="https://github.com/${{ github.repository }}.git"
            fi

            # SSH URL を使う場合は GitHub の host key を事前登録
            if echo "${REPO_URL}" | grep -Eq '^(git@github\.com:|ssh://git@github\.com/)'; then
              mkdir -p "$HOME/.ssh"
              chmod 700 "$HOME/.ssh"
              ssh-keyscan -t ed25519,ecdsa,rsa github.com >> "$HOME/.ssh/known_hosts" 2>/dev/null
              chmod 644 "$HOME/.ssh/known_hosts"

              # EC2 側に GitHub 用秘密鍵がある前提。無い/権限不足はここで明示的に落とす
              if ! ssh -o BatchMode=yes -o ConnectTimeout=10 -T git@github.com >/tmp/github_ssh_check.log 2>&1; then
                if grep -q "Host key verification failed" /tmp/github_ssh_check.log; then
                  echo "GitHub host key verification failed on EC2."
                  cat /tmp/github_ssh_check.log
                  exit 1
                fi
              fi
            fi

            BRANCH="${{ github.ref_name }}"

            # コード同期（存在すれば pull、なければ clone）
            if [ -d "${APP_DIR}/.git" ]; then
              cd "${APP_DIR}"
              git fetch origin "${BRANCH}"
              git checkout "${BRANCH}"
              git pull --ff-only origin "${BRANCH}"
            else
              mkdir -p "$(dirname "${APP_DIR}")"
              git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}" "${APP_DIR}"
              cd "${APP_DIR}"
            fi

            if [ ! -f "${APP_DIR}/srcs/docker-compose.yml" ]; then
              echo "srcs/docker-compose.yml not found in ${APP_DIR}. Check EC2_APP_DIR and EC2_REPO_URL."
              exit 1
            fi

            # ディレクトリ準備
            mkdir -p "${APP_DIR}/srcs/data/mariadb" "${APP_DIR}/srcs/data/wordpress" "${APP_DIR}/secrets"

            # ファイル更新（git pull等の代わり）
            echo "${{ secrets.ENV_FILE }}" > "${APP_DIR}/srcs/.env"
            echo "${{ secrets.CREDENTIALS }}" > "${APP_DIR}/secrets/credentials.txt"
            echo "${{ secrets.DB_ROOT_PASSWORD }}" > "${APP_DIR}/secrets/db_root_password.txt"
            echo "${{ secrets.DB_PASSWORD }}" > "${APP_DIR}/secrets/db_password.txt"

            # デプロイ実行
            echo "[deploy] building images..."
            docker compose -f "${APP_DIR}/srcs/docker-compose.yml" --env-file "${APP_DIR}/srcs/.env" build

            echo "[deploy] starting services..."
            docker compose -f "${APP_DIR}/srcs/docker-compose.yml" --env-file "${APP_DIR}/srcs/.env" up -d --no-build
